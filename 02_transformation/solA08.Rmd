---
title: "Workshop A08: Tidying data"
output: html_document
---

## Introduction

In this exercise we're looking at how to tidy some data up from the COVID-19 pandemic.

Start by going to the Ministry of Health's COVID-19 website:

https://www.health.govt.nz/

click on "Current Cases" and then "View details of confirmed and probable cases".

The direct URL is:

https://www.health.govt.nz/our-work/diseases-and-conditions/covid-19-novel-coronavirus/covid-19-current-situation/covid-19-current-cases/covid-19-current-cases-details

Then download the full data (Excel spreadsheet) and save it to the same folder that this markdown file is in.

You might want to start by loading that up in Excel (if you have it) and taking a look through the spreadsheet.

The following code block should read it in, using the `readxl` library. We also load the `janitor` library which we'll be using to help clean things, and the `lubridate` package for dealing with dates. If you don't have these packages installed (RStudio will have prompted you when you loaded this markdown file) then make sure you install them first.

```{r setup, message=FALSE}
library(tidyverse)
library(readxl)
library(janitor)
library(lubridate)

covid_excel <- read_excel("covid-cases-17aug20.xlsx") # replace this line with the file you downloaded
covid_excel
```

We'll look at tidying these data up and doing some plotting.

**Make sure you can Knit this document successfully before you make changes.**

## Cleaning up the data

The first thing we should notice is that this data contains some three rows before the main column names in the excel sheet. This is fairly common in Excel sheets distributed by government! We can fix this by just skipping the first three rows when we read the file in:

```{r}
covid_excel <- read_excel("covid-cases-17aug20.xlsx",  # replace this line with the file you downloaded
                    skip = 3)
covid_excel
```

That looks better!

Let's now start by doing a plot of the cases through time. We'll first start by cleaning up the column names. The `janitor` package is useful for this.

```{r}
library(janitor)
covid <- covid_excel %>% clean_names()
covid
```

Now that it's done, let's do a plot of the case series

```{r}
ggplot(covid) +
  geom_bar(mapping=aes(x=date_notified_of_potential_case))
```

### Your turn

1. Alter the above plot to split by `sex` (either through colour or via small multiples)

```{r}
covid %>% count(sex)
ggplot(covid %>% filter(!is.na(sex))) +
  geom_bar(mapping=aes(x=date_notified_of_potential_case,
                       fill=sex)) +
  facet_wrap(vars(sex), ncol=1) +
  guides(fill = 'none') +
  labs(x = "Date notified")
```

2. How many cases were there by each age group?

```{r}
covid %>% count(age_group)
```

3. Does the **epidemic curve** (i.e. case count by date) differ by whether or not they had overseas travel?

```{r}
ggplot(covid %>% filter(!is.na(overseas_travel))) +
  geom_bar(aes(x=date_notified_of_potential_case,
               fill=overseas_travel)) +
  facet_wrap(vars(overseas_travel), ncol=1)
```

4. How many cases were there by DHB when those with overseas travel are removed?

```{r}
covid %>%
  filter(overseas_travel != "Yes") %>%
  count(dhb)
```

## Investigation of cases from overseas

An important consideration for border related cases might be the length of time between flight arrival and notification date, as this might be a proxy measure for how long people might be able to potentially spread COVID-19 to others.

The idea is that we assume that overseas cases were positive when they arrived, and thus, until detected were potentially infectious to others. This might give a (very simplistic!!) measure for how long isolation should be so that we pick up cases when testing.

**NOTE: Infectiousness will vary greatly with both time infected and individual characteristics such as age and which symptoms if any the person has. Thus, this is a 'worst' case measure, where we assume infectious for the entire period up until case notification. In practice, the infectious period will be shorter than this.**

We'll start by looking at what *type* of data the date variables are:

```{r}
glimpse(covid)
```

You can see that most of the variables are "chr", short for character string, while the dates are "dttm" objects - date times. Thus, they store not only the date information but also time information. The consequence of this is if we subtract them to find the time difference, we'll end up as a measure in seconds. The `lubridate` library has a `time_length` function for converting this to days.

```{r}
overseas <- covid %>%
  filter(overseas_travel == "Yes") %>%
  mutate(difference = date_notified_of_potential_case - arrival_date,
         length = time_length(difference, unit="day"))
overseas
```

### Your turn

1. Investigate the distribution of the length prior to notification by looking at the distribution (e.g. using a histogram, boxplot or density).

```{r}
overseas %>% filter(length > 30)
ggplot(overseas) +
  geom_boxplot(aes(x=length))
```

2. How many are notified after the 14 days that is used as the isolation period at the border?

```{r}
overseas %>%
  filter(length > 14) %>%
  summarise(total = n())
```

We're picking up over 90% of cases within the 14 days, so this seems like a pretty good bar for detection. The ones that are much more are ones where we know they were a case much earlier in the process (i.e. they had symptoms but didn't get tested until much later), plus some that presumably were detected in managed isolation and who were there for longer than the 2 weeks (e.g. Dad gets identified as a positive case at Day 10 -> family moves to quarantine -> another family member gets detected a week later).

3. Presumably the notified date depends on when they were tested - if they are tested in isolation (as was happening with everyone after June 16) then we'd expect fairly early detection, whereas if they left isolation without a test (as they were asymptomatic) it might be later. Investigate how the length changes during the epidemic.

```{r}
overseas %>%
  filter(length < 100) %>%
  ggplot() +
  geom_point(aes(x=date_notified_of_potential_case, y=length)) +
  geom_smooth(aes(x=date_notified_of_potential_case, y=length),
              method='gam') +
  geom_hline(yintercept = 14, col='red')
```

This shows we tend to be picking people up reasonably early in managed isolation (good!) averaging around a week. In the first wave we initially picked people up early (presumably they were already symptomatic) but that this stretched out during the wave (possibly picking up those that were asymptomatic on arrival and later developed symptoms?) A few were picked up very late in the process!

I'd be really interested in seeing if you come up with a better plot that shows what we want to here! :)
